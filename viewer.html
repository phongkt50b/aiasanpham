<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Viewer Bảng Minh Họa</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --max-width: 1000px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    body {
      margin:0;
      background:#fafafa;
      color:#222;
      line-height:1.5;
    }
    header {
      background:#fff;
      border-bottom:1px solid #e5e5e5;
      position:sticky; top:0; z-index:20;
    }
    #toolbar {
      max-width:var(--max-width);
      margin:0 auto;
      padding:12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    #toolbar h1 { margin:0; font-size:18px; font-weight:600; }
    button {
      cursor:pointer;
      background:#d4002a;
      border:1px solid #d4002a;
      color:#fff;
      padding:8px 14px;
      font-size:14px;
      border-radius:4px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover,
    button:focus {
      background-color: #a30021;
      box-shadow: 0 4px 8px rgba(163, 0, 33, 0.4);
      outline: none;
    }
    button:disabled {
      background-color: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      box-shadow: none;
      color: #666;
    }
    button.secondary {
      background:#f5f5f5;
      color:#222;
      border:1px solid #ccc;
    }
    main {
      max-width:var(--max-width);
      margin:28px auto 80px;
      padding:0 18px;
    }
    .status {
      font-size:14px;
      color:#555;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status::before {
      content:"";
      width:14px; height:14px;
      border:2px solid #d4002a;
      border-right-color:transparent;
      border-radius:50%;
      animation:spin .9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg);} }
    .hidden { display:none !important; }

    /* Khối ảnh full-width */
    .viewer-image-block {
      margin:40px 0 48px;
    }
    .viewer-image-block figure {
      margin:0 0 32px;
      background:#fff;
      border:1px solid #e5e5e5;
      border-radius:8px;
      padding:10px;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
      cursor:zoom-in;
      transition:box-shadow .25s;
    }
    .viewer-image-block figure:hover {
      box-shadow:0 5px 20px rgba(0,0,0,.15);
    }
    .viewer-image-block img {
      width:100%;
      height:auto;
      display:block;
      border-radius:4px;
      object-fit:contain;
      background: #eee; /* placeholder màu xám nhạt */
      transition: background 0.3s ease;
    }
    .viewer-image-block img.loaded {
      background: transparent;
    }
    .viewer-image-block figcaption { display:none !important; }

    /* Lightbox */
    #lightboxOverlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,.85);
      display:flex; align-items:center; justify-content:center;
      padding:40px 30px;
      z-index:999;
      opacity:0; pointer-events:none;
      transition:opacity .25s;
    }
    #lightboxOverlay.active {
      opacity:1; pointer-events:auto;
    }
    #lightboxOverlay img {
      max-width:95vw;
      max-height:95vh;
      object-fit:contain;
      background:#111;
      border:1px solid #444;
      border-radius:4px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      cursor:zoom-out;
    }
    #lightboxOverlay .close-btn {
      position:fixed;
      top:14px; right:22px;
      font-size:32px; color:#fff;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .lb-nav-btn {
      position:fixed;
      top:50%; transform:translateY(-50%);
      width:58px; height:58px;
      display:flex; align-items:center; justify-content:center;
      border-radius:50%;
      font-size:40px;
      background:rgba(255,255,255,.18);
      color:#fff; border:none; cursor:pointer;
      transition:background .25s;
    }
    .lb-nav-btn:hover { background:rgba(255,255,255,.35); }
    .lb-prev { left:30px; }
    .lb-next { right:30px; }

    /* Print */
    @media print {
      header, #lightboxOverlay { display:none !important; }
      body { background:#fff; }
      .viewer-image-block figure { page-break-inside:avoid; }
    }

    #summary-wrapper {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
      line-height: 1.5;
      max-width: 100%;
      overflow-x: auto;
      padding-bottom: 14px;
      font-size: 14px; /* cỡ chữ chuẩn */
    }
    #summary-wrapper * {
      font-size: inherit !important;
    }

    #summary-wrapper h3 {
      font-weight: 600;
      margin-top: 14px;
      margin-bottom: 14px;
      color: #b91c1c;
    }

    #summary-wrapper table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
      margin-bottom: 14px;
      font-size: 14px;
      background: #fff;
    }

    #summary-wrapper th, 
    #summary-wrapper td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      vertical-align: top;
      text-align: left;
    }

    #summary-wrapper th {
      background-color: #f3f4f6;
      font-weight: 600;
      color: #444;
      text-align: center;
    }

    #summary-wrapper tr:nth-child(even) {
      background-color: #fafafa;
    }

    #summary-wrapper strong {
      font-weight: 600;
    }

    #summary-wrapper .text-red-600 {
      color: #b91c1c;
    }

    /* --- Phần 1: Bảng tóm tắt sản phẩm --- */
    /* Căn phải từ cột 3 (STBH) trở đi */
    #summary-wrapper table:nth-of-type(1) td:nth-child(n+3) {
      text-align: right;
    }
    /* Dòng tổng cuối cùng của bảng 1 */
    /* Ô đầu tiên căn trái và bôi đậm */
    #summary-wrapper table:nth-of-type(1) tr:last-child td:first-child {
      text-align: left;
    }
    /* Các ô còn lại căn phải và bôi đậm */
    #summary-wrapper table:nth-of-type(1) tr:last-child td:not(:first-child) {
      text-align: right;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.20.0",
    "marked": "https://aistudiocdn.com/marked@^16.3.0"
  }
}
</script>
</head>
<body>
  <header>
    <div id="toolbar">
      <h1>Bảng minh họa (Viewer)</h1>
      <div class="actions">
        <button id="btnExportPdf">In / PDF</button>
        <button id="btnExportHtml">Tải HTML</button>
        <button class="secondary" id="btnReload">Tải lại</button>
      </div>
    </div>
  </header>
  <main id="content">
    <div id="status" class="status">Đang tải dữ liệu...</div>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightboxOverlay">
    <span class="close-btn" aria-label="Đóng">×</span>
    <button class="lb-nav-btn lb-prev" title="Trước">‹</button>
    <img src="" alt="" />
    <button class="lb-nav-btn lb-next" title="Sau">›</button>
  </div>

  <script>
  (function(){
  const state = {
    payload:null,
    images:[],
    currentIndex:0
  };

  function decodePayload(){
    const h = location.hash || '';
    if(!h.startsWith('#v=')) throw new Error('Thiếu payload (#v=...)');
    const b64 = h.slice(3);
    // Giải mã base64 thành chuỗi JSON đúng UTF-8
    const jsonStr = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(jsonStr);
  }

  function qs(sel,root=document){ return root.querySelector(sel); }
  function qa(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

  function buildSummaryHtmlFromPayload(p){
    return p.summaryHtml || '<div class="text-red-600">Không có summaryHtml trong payload.</div>';
  }

  // Tối ưu: tải ảnh song song, lọc url tồn tại
  async function collectParallelLimited(baseDir, baseName, max=10) {
    const urls = [];
    for(let i=1; i<=max; i++) {
      const num = String(i).padStart(2,'0');
      urls.push(`${baseDir}/${baseName}-${num}.jpg`);
    }

    const fetchPromises = urls.map(url =>
      fetch(url, { method: 'HEAD', cache: 'no-store', mode: 'cors' })
        .then(res => res.ok ? url : null)
        .catch(() => null)
    );

    const results = await Promise.all(fetchPromises);
    return results.filter(x => x !== null);
  }

  function renderImageBlock(urls, isFirstBlock = false){
    if(!urls.length) return null;
    const wrap=document.createElement('div');
    wrap.className='viewer-image-block';

    const fragment = document.createDocumentFragment();
    urls.forEach((u, index)=>{
      const fig=document.createElement('figure');
      const img=document.createElement('img');
      img.src=u;
      img.alt='Ảnh minh họa';
      
      const isFirstImageOverall = isFirstBlock && index === 0;
      if (!isFirstImageOverall) {
        img.loading = 'lazy';
      }

      img.addEventListener('load', () => {
        img.classList.add('loaded');
      });
      img.addEventListener('error', () => {
        img.classList.remove('loaded');
        // Có thể gán ảnh dự phòng nếu muốn
        // img.src = 'images/placeholder.png';
      });
      fig.appendChild(img);
      fig.addEventListener('click',()=>openLightbox(u));
      fragment.appendChild(fig);
    });
    wrap.appendChild(fragment);

    state.images = state.images.concat(urls);
    return wrap;
  }

  /* ---------- LIGHTBOX ---------- */
  function setupLightbox(){
    const overlay=qs('#lightboxOverlay');
    const img=overlay.querySelector('img');
    const closeBtn=overlay.querySelector('.close-btn');
    const prevBtn=overlay.querySelector('.lb-prev');
    const nextBtn=overlay.querySelector('.lb-next');

    function show(idx){
      if(idx<0||idx>=state.images.length) return;
      state.currentIndex=idx;
      img.src=state.images[idx];
      overlay.classList.add('active');
      updateNav();
    }
    function hide(){
      overlay.classList.remove('active');
      img.src='';
    }
    function updateNav(){
      prevBtn.disabled=(state.currentIndex===0);
      nextBtn.disabled=(state.currentIndex===state.images.length-1);
    }
    function shift(d){
      const ni=state.currentIndex+d;
      if(ni>=0 && ni<state.images.length) show(ni);
    }

    prevBtn.addEventListener('click',()=>shift(-1));
    nextBtn.addEventListener('click',()=>shift(1));
    closeBtn.addEventListener('click',hide);
    overlay.addEventListener('click',e=>{ if(e.target===overlay) hide(); });
    document.addEventListener('keydown',e=>{
      if(!overlay.classList.contains('active')) return;
      if(e.key==='Escape') hide();
      if(e.key==='ArrowLeft') shift(-1);
      if(e.key==='ArrowRight') shift(1);
    });
    window._lbOpenSrc = (src)=>{
      const idx=state.images.indexOf(src);
      if(idx!==-1) show(idx);
    };
  }
  function openLightbox(src){
    if(window._lbOpenSrc) window._lbOpenSrc(src);
  }

  /* ---------- MAIN RENDER ---------- */
  async function render(){
    const payload = state.payload;
    const main = qs('#content');
    const statusEl = qs('#status');
    statusEl.classList.add('hidden');
    main.innerHTML = '';
    state.images = [];

    // 1. Gắn summaryHtml
    const summaryHtml = buildSummaryHtmlFromPayload(payload);
    const container = document.createElement('div');
    container.id = 'summary-wrapper';
    container.innerHTML = summaryHtml;
    main.appendChild(container);

    // Fix căn chỉnh bảng
    function fixTableAlignments() {
      const tables = container.querySelectorAll('table');
      if (tables.length === 0) return;

      for(let i=1; i < tables.length - 1; i++) {
        const table = tables[i];
        table.querySelectorAll('tbody tr').forEach(tr => {
          tr.querySelectorAll('td').forEach((td, idx) => {
            if (idx === 0) td.style.textAlign = 'left';
            else td.style.textAlign = 'right';
          });
        });
      }

      const lastTable = tables[tables.length - 1];
      if (lastTable) {
        lastTable.querySelectorAll('tbody tr').forEach(tr => {
          tr.querySelectorAll('td').forEach((td, idx) => {
            if (idx === 0 || idx === 1) td.style.textAlign = 'center';
            else td.style.textAlign = 'right';
          });
        });
      }
    }
    fixTableAlignments();

    // Bôi đậm dòng tổng, quyền lợi đặc biệt
    const rows = container.querySelectorAll('tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      if (text.includes('tổng') || text.includes('quyền lợi thai sản') || text.includes('quyền lợi ngoại trú') || text.includes('quyền lợi nha khoa')|| text.includes('điều trị ung thư')) {
        row.style.fontWeight = '700';
      }
    });

    // 2. Chèn ảnh công ty TRƯỚC TOÀN BỘ bảng minh họa (trước container)
    const companyImgs = await collectParallelLimited('images/company','company',10);
    const companyBlock = renderImageBlock(companyImgs, true);
    if(companyBlock){
      if(container.parentNode){
        container.parentNode.insertBefore(companyBlock, container);
      } else {
        container.prepend(companyBlock);
      }
    }

    // 3. Chèn ảnh sản phẩm chính và riders sau phần 3 (giới hạn 10 ảnh mỗi loại)
    const part3Headings = qa('h3', container).filter(h => /Phần\s*3/i.test(h.textContent));
    const lastPart3 = part3Headings.length ? part3Headings[part3Headings.length - 1] : null;
    let insertAfterNode = lastPart3 ? lastPart3.parentElement : container.lastElementChild;

    // 3.1 Ảnh sản phẩm chính
    const prodSlug = payload.productSlug || (payload.productKey || '').toLowerCase();
    const productImgs = await collectParallelLimited(`images/products/${prodSlug}`, prodSlug, 10);
    if(productImgs.length){
      const prodBlock = renderImageBlock(productImgs);
      if(insertAfterNode && insertAfterNode.parentNode){
        insertAfterNode.parentNode.insertBefore(prodBlock, insertAfterNode.nextSibling);
        insertAfterNode = prodBlock;
      } else {
        container.appendChild(prodBlock);
        insertAfterNode = prodBlock;
      }
    }

    // 3.2 Ảnh riders - tải song song
    if(Array.isArray(payload.premiums?.riders)){
      const riderSlugMap = {
        health_scl:'bung-gia-luc',
        bhn:'benh-hiem-ngheo-20',
        accident:'tai-nan',
        hospital_support:'ho-tro-vien-phi',
      };

      const selectedRiders = payload.premiums.riders.filter(r => r.selected);
      const riderPromises = selectedRiders.map(async r => {
        const rSlug = riderSlugMap[r.slug];
        if(!rSlug) return null;
        const imgs = await collectParallelLimited(`images/products/${rSlug}`, rSlug, 10);
        return imgs.length ? { imgs, rSlug } : null;
      });

      const riderResults = (await Promise.all(riderPromises)).filter(x => x !== null);

      riderResults.forEach(({imgs}) => {
        const riderBlock = renderImageBlock(imgs);
        if(insertAfterNode && insertAfterNode.parentNode){
          insertAfterNode.parentNode.insertBefore(riderBlock, insertAfterNode.nextSibling);
          insertAfterNode = riderBlock;
        } else {
          container.appendChild(riderBlock);
          insertAfterNode = riderBlock;
        }
      });
    }
  }
async function exportHtmlWithEmbeddedImages() {
  // Lấy toàn bộ nội dung trong #content để bao gồm cả ảnh công ty
  const mainContent = document.querySelector('#content');
  if (!mainContent) {
    alert('Không có nội dung để tải.');
    return;
  }
  // Clone nội dung để xử lý mà không ảnh hưởng tới DOM gốc
  const clone = mainContent.cloneNode(true);

  // Lấy tất cả thẻ img trong clone
  const imgs = clone.querySelectorAll('img');

  // Hàm lấy Base64 từ URL ảnh
  async function toBase64(url) {
    try {
      const response = await fetch(url);
      if(!response.ok) throw new Error('Không tải được ảnh');
      const blob = await response.blob();
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.warn('Không thể tải ảnh:', url, e);
      return url; // fallback trả lại url gốc nếu lỗi
    }
  }

  // Duyệt từng ảnh, thay src thành base64
  for (const img of imgs) {
    const src = img.getAttribute('src');
    if (src && !src.startsWith('data:')) {
      // Chuyển src thành URL tuyệt đối
      const absUrl = new URL(src, location.href).href;
      const base64 = await toBase64(absUrl);
      img.setAttribute('src', base64);
    }
  }

  const innerHtml = clone.innerHTML;

  const styles = Array.from(document.querySelectorAll('head style, head link[rel="stylesheet"]'))
    .map(node => node.outerHTML).join('\n');

  const extraStyle = `
  <style>
    body {
      margin: 20px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #fafafa;
      color: #222;
    }
    #summary-wrapper {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 18px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
      line-height: 1.5;
    }
    #summary-wrapper table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
      margin-bottom: 14px;
      background: #fff;
    }
    #summary-wrapper th, #summary-wrapper td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      vertical-align: top;
      text-align: left;
    }
    #summary-wrapper th {
      background-color: #f3f4f6;
      font-weight: 600;
      color: #444;
      text-align: center;
    }
    /* Căn phải từ cột 3 trở đi trong bảng 1 */
    #summary-wrapper table:nth-of-type(1) td:nth-child(n+3) {
      text-align: right;
    }
    /* Dòng tổng cuối cùng của bảng 1 */
    #summary-wrapper table:nth-of-type(1) tr:last-child td:first-child {
      text-align: left;
      font-weight: 700;
    }
    #summary-wrapper table:nth-of-type(1) tr:last-child td:not(:first-child) {
      text-align: right;
      font-weight: 700;
    }
  </style>`;

  const fullHtml = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bảng Minh Họa - Xuất HTML</title>
  ${styles}
  ${extraStyle}
</head>
<body>
  ${innerHtml}
</body>
</html>`;

  // Hàm tạo chuỗi ngày giờ theo format dd-mm-yy - hh-mm
  function getFormattedDateTime() {
    const now = new Date();
    const pad2 = n => n.toString().padStart(2, '0');
    const day = pad2(now.getDate());
    const month = pad2(now.getMonth() + 1);
    const year = now.getFullYear().toString().slice(-2);
    const hour = pad2(now.getHours());
    const minute = pad2(now.getMinutes());
    return `${day}-${month}-${year} - ${hour}-${minute}`;
  }

  // Hàm thay thế ký tự không hợp lệ trong tên file
  function sanitizeFileName(name) {
    return name.replace(/[\/\\?%*:|"<>]/g, '-').trim();
  }

  // Lấy tên người được bảo hiểm chính từ payload
  let rawName = 'NguoiDuocBaoHiem';
  if (state.payload && state.payload.mainPersonName) {
    rawName = state.payload.mainPersonName;
  }
  const safeName = sanitizeFileName(rawName);
  const dateTimeStr = getFormattedDateTime();
  const fileName = `${safeName} - ${dateTimeStr}.html`;

  const blob = new Blob([fullHtml], {type: 'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 0);
}

  
  function setupButtons(){
    qs('#btnExportPdf').addEventListener('click', ()=>window.print());
    qs('#btnExportHtml').addEventListener('click', exportHtmlWithEmbeddedImages);
    qs('#btnReload').addEventListener('click', ()=>location.reload());
  }
  function init(){
    setupButtons();
    setupLightbox();
    try {
      state.payload = decodePayload();
      render();
    } catch(e){
      console.error(e);
      const st=qs('#status');
      st.textContent='Không đọc được dữ liệu.';
    }
  }
  document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
